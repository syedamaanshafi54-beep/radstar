rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // Checks if the user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Checks if the user is the owner of the document
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Checks if the user is an admin
    function isAdmin() {
      return isSignedIn() && (
        request.auth.uid == 'Grp5q6hyTYbS01As4JyEcKam9BH2' ||
        request.auth.token.email in ['itsmeabdulk@gmail.com'] ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
    }

    // --- USERS RESOURCE ---
    // Architecture: Users own their subtree. Admins have override access.
    match /users/{userId} {
      // 1. User Document Access
      allow read, write: if isOwner(userId) || isAdmin();

      // 2. Orders Subcollection Access
      // Matches: /users/{userId}/orders/{orderId}
      // This allows both listing the collection and reading individual orders
      match /orders/{orderId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }

      // 3. Catch-all for other subcollections (future proofing)
      match /{subcol}/{docId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
    }

    // --- ADMIN DASHBOARD ---
    // Architecture: Admin needs 'collectionGroup' access to ALL orders
    // This rule allows queries like collectionGroup('orders')
    match /{path=**}/orders/{orderId} {
      allow read: if isAdmin();
    }

    // --- PUBLIC/MIXED RESOURCES ---
    
    // Reviews: Public read, Authenticated create, Owner/Admin manage
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && (
        (request.auth.uid == resource.data.userId) || isAdmin()
      );
    }

    // Products: Public read, Admin managed
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    // Recursive wildcard for nested product data if any
    match /products/{productId}/{allChildren=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Site Config: Public read, Admin managed
    match /site-config/{configId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /site-config/{configId}/{allChildren=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Categories: Public read, Admin managed
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Partners: Public creation (application), Admin read
    match /partners/{partnerId} {
      allow create: if true;
      allow read: if isAdmin();
    }

    // --- VENDORS RESOURCE ---
    match /vendors/{vendorId} {
      // Users can create their own vendor application
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      // Allow get if owner or admin
      allow get: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
      
      // Allow list if admin or if filtering by own userId
      allow list: if isAdmin() || (isSignedIn() && request.query.filters.userId == request.auth.uid);
      
      // Only admins can update or delete
      allow update, delete: if isAdmin();
    }

    // Vendor Discount History: Admin write, Vendor can read their own
    match /vendorDiscountHistory/{historyId} {
      allow read: if isSignedIn() && (resource.data.vendorId == request.auth.uid || isAdmin());
      allow list: if isAdmin();
      allow write: if isAdmin();
    }

    // --- METADATA RESOURCE ---
    // Used for counters and system-wide settings
    match /metadata/{docId} {
      // Allow authenticated users to read/write the userCounter for ID generation
      allow read, write: if isSignedIn(); 
    }
  }
}
