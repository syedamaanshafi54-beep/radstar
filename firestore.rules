rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- ADMIN HELPER ---
    // Decisive admin check for your primary account
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.email == 'itsmeabdulk@gmail.com' || 
        request.auth.uid == 'Grp5q6hyTYbS01As4JyEcKam9BH2' ||
        request.auth.token.role == 'admin'
      );
    }

    // DECISIVE ADMIN ACCESS: Grant absolute control to the admin account.
    match /{allPaths=**} {
      allow read, write, list: if isAdmin();
    }

    // --- REVIEWS ---
    // Smart Decouple: Anyone can read, logged-in USERS ONLY can create, Admin/Owner can moderate.
    match /reviews {
      allow read: if true;
    }
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if request.auth != null && !isAdmin();
      allow update, delete: if request.auth != null && (request.auth.uid == resource.data.userId || isAdmin());
    }

    // --- ORDERS ---
    // Universal access for Admin to ANY path containing 'orders'
    // This covers both top-level and nested collections absolutely.
    match /{allPaths=**}/orders/{orderId} {
      allow read, write, list: if isAdmin();
    }
    
    // Explicit collection group query support
    match /{path=**}/orders {
      allow list: if isAdmin();
    }
    
    // Explicit match for owners
    match /users/{userId}/orders/{orderId} {
      allow read: if request.auth != null && request.auth.uid == userId;
    }
    
    // Top-level fallback + list for collectionGroup
    match /orders/{orderId} {
      allow read, write, list: if isAdmin();
    }

    // --- PRODUCTS ---
    match /products {
       allow read: if true;
       allow write: if isAdmin();
    }
    match /products/{productId=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- SITE CONFIG ---
    match /site-config/{configId=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- USERS ---
    match /users/{userId} {
      allow read, write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      match /{allPaths=**} {
        allow read, write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      }
    }

    // --- PARTNERS ---
    match /partners/{partnerId=**} {
      allow create: if true;
      allow read: if isAdmin();
    }
  }
}
